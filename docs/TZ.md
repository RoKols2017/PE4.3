# ТЗ: Проект Python для озвучки текста через ElevenLabs и Telegram-бота

## 1) Цель и границы
Создать минимальный, но production-готовый сервис для генерации аудио из текста с выбором голоса пользователем в Telegram. Сервис использует ElevenLabs API. В поставку входит рабочий код, базовые тесты, документация по запуску.

Вне рамок: продвинутая модерация контента, биллинг, база данных пользователей (используем in-memory кэш).

---

## 2) Результаты (Deliverables)
- Репозиторий с файлами:
  - `.env` — переменные окружения.
  - `.env_example` — пример переменных окружения (шаблон для разработчиков).
  - `voice.py` — обёртка над ElevenLabs: получение голосов и генерация аудио.
  - `main.py` — Telegram-бот: клавиатура выбора голоса, ввод текста, генерация и отправка аудио.
- `README.md` — как запустить.
- `requirements.txt` — зависимости.
- `.gitignore` — исключает секреты и артефакты.
- Минимальные тесты (`tests/test_voice.py`) на happy-path.

---

## 3) Технологии и версии
- Python 3.11+
- Библиотеки:
  - `python-telegram-bot==21.*`
  - `elevenlabs==1.*`
  - `python-dotenv==1.*`
  - `pydantic==2.*` (валидация конфигурации)
  - `pytest==8.*` (тесты)
- Аудио формат по умолчанию: `audio/mpeg` (mp3, 48kHz, mono).

---

## 4) Архитектура и потоки
1) Пользователь запускает бота → получает инлайн-клавиатуру со списком голосов.  
2) Выбирает голос → бот сохраняет `voice_id` в памяти с TTL.  
3) Пользователь отправляет текст (или отвечает на «Введите текст…») → бот вызывает `voice.synthesize_speech()` → получает байты mp3.  
4) Бот отправляет аудио пользователю (как `voice` или `audio`, см. настройку).  
5) Ошибки логируются и возвращаются пользователю дружелюбно («Не удалось сгенерировать аудио. Попробуйте позже.»).

---

## 5) Переменные окружения (.env)
```
ELEVENLABS_API_KEY=your_elevenlabs_api_key
TELEGRAM_BOT_TOKEN=your_telegram_bot_token
DEFAULT_VOICE_ID=EXAVITQu4vr4xnSDxMaL
AUDIO_FORMAT=mp3
TMP_DIR=./tmp
SEND_AS=voice   # options: voice|audio
LOG_LEVEL=INFO
```
Требования:
- `.env` не коммитить (см. `.gitignore`).
- Добавить файл `.env_example` с шаблоном переменных окружения для разработчиков.
- Значения валидируются при старте (pydantic).

---

## 6) Файл `voice.py`
Назначение: инкапсулировать работу с ElevenLabs.

### 6.1 Публичные функции
- `get_voices() -> list[dict]`  
  Возвращает список доступных голосов: `[{ "id": str, "name": str, "labels": dict|None }]`.  
  Кеширование на 10 минут, чтобы не упираться в лимиты.

- `synthesize_speech(text: str, voice_id: str, fmt: str = "mp3") -> bytes`  
  Валидирует вход (длина текста ≤ 5000 символов), генерирует аудио, возвращает байты.  
  Ретраи на 429/5xx (экспоненциальная пауза: 0.5s, 1s, 2s; максимум 3 попытки).

### 6.2 Ошибки
- Определить кастомные исключения: `VoiceServiceError`, `RateLimitError`, `InvalidInputError`.
- Логирование уровней: INFO (успех), WARNING (ретраи), ERROR (фатал).

### 6.3 Пример использования ElevenLabs (включить в код-комментарий)
```python
from elevenlabs import ElevenLabs

client = ElevenLabs(
    api_key="YOUR_API_KEY",
)
client.service_accounts.api_keys.create(
    service_account_user_id="service_account_user_id",
    name="name",
    permissions=["text_to_speech"],
)
```

---

## 7) Файл `main.py` (Telegram-бот)
Функциональные требования:
- Команды:
  - `/start` — приветствие, загрузка/кеш голосов, вывод клавиатуры выбора.
  - `/voice` — повторно показать выбор голосов.
  - `/help` — краткая справка.
- Клавиатура:
  - Инлайн-кнопки постранично (по 6–8 голосов на страницу).
  - Кнопки «⟵ Назад / Далее ⟶», «Обновить список».
- Сценарии:
  1) Выбор голоса → подтверждение («Голос: {name}»), подсказка «Отправьте текст для озвучки».
  2) Получение текста:
     - Если выбран голос — синтез и отправка.
     - Если нет — использовать `DEFAULT_VOICE_ID` и подсказать про `/voice`.
- Отправка аудио:
  - `SEND_AS=voice` → `send_voice` (OGG/Opus желателен; для mp3 завернуть в `audio` если Telegram не примет).
  - `SEND_AS=audio` → `send_audio` (mp3 с `title`, `performer`, `duration` если доступно).
- Обработка ошибок:
  - Таймаут ElevenLabs/сети: «Сервис перегружен, попробуйте позже».
  - Недопустимый текст: «Слишком длинный текст (>{N}). Сократите, пожалуйста».
- rate-limit Telegram: аккуратная сериализация ответов (очередь задач не требуется, но задержка 50–100 мс между отправками).

Состояние:
- In-memory `dict[user_id] -> {"voice_id": str, "updated_at": dt}` с автоочисткой (TTL 24 ч).

Логи:
- Старт/останов, входящие апдейты (уровень DEBUG можно отключать), ошибки внешних API.

---

## 8) Нефункциональные требования
- Код-стиль: PEP8, типизация (mypy-чистота по минимуму).
- Надёжность: обработка 429/5xx, ретраи, таймауты (HTTP timeout 15s).
- Безопасность: ключи только из env; не логировать токены/тексты пользователей.
- Производительность: генерация одной дорожки ≤ 5 сек при нормальной загрузке (зависит от ElevenLabs).
- Международность: UTF-8, поддержка кириллицы и эмодзи.
- Масштабируемость: stateless-логика бота (перенос состояния в Redis — в будущем).

---

## 9) UX-детали (минимум)
- Короткие подсказки после каждого шага.
- Сообщения об ошибках без тех. жаргона.
- Пагинация голосов, отображение имени + ярлыков (если есть).

---

## 10) Тестирование и приёмка
- Юнит-тесты:
  - `test_get_voices_returns_list`
  - `test_synthesize_speech_returns_bytes`
  - Моки HTTP-клиента ElevenLabs.
- Ручная проверка:
  - `/start` → список голосов → выбор → ввод текста → пришло аудио.
  - Смена голоса.
  - Ошибка при недоступности ElevenLabs (см. заглушку).
- Критерии готовности:
  - Проект запускается с локальными ключами.
  - Голоса подгружаются и листаются.
  - Аудио генерируется и доставляется пользователю.
  - Нет утечек ключей в логах и репозитории.

---

## 11) Структура проекта
```
project/
├─ main.py
├─ voice.py
├─ .env                 # локально, не коммитить
├─ .env_example         # шаблон переменных окружения
├─ requirements.txt
├─ README.md
├─ .gitignore
└─ tests/
   └─ test_voice.py
```

---

## 12) Минимальный контент файлов

### 12.1 `.env_example` (шаблон)
```
ELEVENLABS_API_KEY=your_elevenlabs_api_key
TELEGRAM_BOT_TOKEN=your_telegram_bot_token
DEFAULT_VOICE_ID=EXAVITQu4vr4xnSDxMaL
AUDIO_FORMAT=mp3
TMP_DIR=./tmp
SEND_AS=voice
LOG_LEVEL=INFO
```

(остальной код `voice.py`, `main.py` — как описано выше)

---

## 13) Безопасность и комплаенс
- Переменные окружения — единственный источник секретов.
- Логи не содержат исходный текст пользователя и ключи.
- В README — предупреждение о хранении `.env` вне VCS.

---

## 14) Эксплуатация
- Запуск:
  ```
  python -m venv .venv && source .venv/bin/activate
  pip install -r requirements.txt
  cp .env_example .env
  python main.py
  ```
- Health-check: при старте бот логирует количество доступных голосов.

---

## 15) Дорожная карта (на будущее, «взрослый» взгляд)
- Хранение предпочтений в Redis/Postgres.
- Ограничение длины/скорости для злоупотреблений (per-user rate limit).
- Загрузка/озвучка текстовых файлов и ссылок.
- Выбор параметров TTS (темп, тишина, эмоции).
- Docker-образ, CI/CD, Sentry.

---

Если кратко: «минимум кнопок, максимум пользы». Голоса листаем, текст — в звук, звук — пользователю. Дальше масштабируем по мере роста.
